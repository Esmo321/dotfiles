#! /bin/bash

DIR="$(dirname "$0")/modules"

RUNCFG="$(cat "$DIR/rc.conf" | sed '/^#/ d')"

RUNLIST=""

for ENTRY in $(printf "$RUNCFG"); do

	MDIR=$(echo $ENTRY | sed "s:\/.*::")
	MLIST=$(echo $ENTRY | sed "s:.*\/::; s:,:\n:g")

	ENTRYLIST="$MLIST"

	if [ "$MLIST" == "*" ]; then
		ENTRYLIST=$(find "$DIR/$MDIR" -type f -printf "%P\n")
	fi

	ENTRYLIST=$(printf "$ENTRYLIST" | sed "s/^/$MDIR\//")

	RUNLIST="$RUNLIST$ENTRYLIST\n"

done

RUNLIST=$(printf "$RUNLIST" | awk '!a[$0]++')

if [ "$1" == "--dry-run" ]; then

	printf "$RUNLIST\n"
	exit

fi

for MOD in $(printf "$RUNLIST"); do

	MPATH="$DIR/$MOD"

	if [ -f "$MPATH" ]; then

		if [ ! -x "$MPATH" ]; then		
			chmod +x "$MPATH"
		fi

		nohup "$MPATH" &> /dev/null&

	fi

done